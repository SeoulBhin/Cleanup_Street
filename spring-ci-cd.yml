name: Spring Backend CI/CD (Blue/Green)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: self-hosted
    env:
      IMAGE_NAME: ghcr.io/seoulbhin/cleanup-street-spring
      CONTAINER_PREFIX: cleanup-street-spring
      # Optional overrides; defaults below in the deploy step keep prod pointing to the correct DB port (5433).
      DB_HOST: ${{ secrets.DB_HOST }}
      DB_PORT: ${{ secrets.DB_PORT }}
      DB_USER: ${{ secrets.DB_USER }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      DB_DATABASE: ${{ secrets.DB_DATABASE }}
      BACKEND_ENV_FILE: /home/ec2-user/backend.env

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Login to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GHCR_TOKEN }}

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build and push Spring Docker image
      id: build_and_push
      uses: docker/build-push-action@v4
      with:
        context: ./backend
        push: true
        tags: |
          ${{ env.IMAGE_NAME }}:${{ github.sha }}
          ${{ env.IMAGE_NAME }}:latest

    - name: ðŸ”§ Pre-Deployment Cleanup
      run: |
        echo "ðŸ§¹ Cleaning up Docker resources..."
        docker container prune -f
        docker image prune -af
        docker volume prune -f
        docker network prune -f
        echo "âœ… Cleanup done"

    - name: Deploy with Blue/Green Strategy
      env:
        SPRING_PROFILES_ACTIVE: prod
        SPRING_DATASOURCE_URL: ${{ secrets.SPRING_DATASOURCE_URL }}
        SPRING_DATASOURCE_USERNAME: ${{ secrets.SPRING_DATASOURCE_USERNAME }}
        SPRING_DATASOURCE_PASSWORD: ${{ secrets.SPRING_DATASOURCE_PASSWORD }}
        JAVA_TOOL_OPTIONS: "-XX:MaxRAMPercentage=75.0 -XX:+UseG1GC"
        HEALTH_PATH: "/actuator/health"
        INITIAL_SLEEP: 20
        RETRIES: 10
        RETRY_INTERVAL: 5
        IMAGE_TAG: ${{ github.sha }}
        REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
      run: |
        echo "ðŸš€ Starting Blue/Green Deployment for tag: ${IMAGE_TAG}"

        # DB env defaults (can be overridden via GitHub secrets above)
        DB_HOST=${DB_HOST:-52.63.57.185}
        DB_PORT=${DB_PORT:-5433}
        DB_USER=${DB_USER:-user}
        DB_PASSWORD=${DB_PASSWORD:-1234}
        DB_DATABASE=${DB_DATABASE:-cleanup}
        REDIS_HOST=${REDIS_HOST:-cleanup-redis}
        REDIS_PORT=${REDIS_PORT:-6379}
        REDIS_PASSWORD=${REDIS_PASSWORD:-0000}
        ENV_FILE=${BACKEND_ENV_FILE:-/home/ec2-user/backend.env}

        # Ensure env file exists and load it to export variables explicitly
        if [ ! -f "${ENV_FILE}" ]; then
          echo "âŒ Env file not found at ${ENV_FILE}"
          exit 1
        fi
        set -a
        . "${ENV_FILE}"
        set +a

        # Ensure shared network exists (Redis + app)
        docker network create cleanup-net || true

        EXISTING_BLUE=$(docker ps -q -f name=${CONTAINER_PREFIX}-blue)
        if [ -z "$EXISTING_BLUE" ]; then
          NEW_COLOR="blue"
          OLD_COLOR="green"
          NEW_PORT=9090
        else
          NEW_COLOR="green"
          OLD_COLOR="blue"
          NEW_PORT=9091
        fi

        echo "Deploying new version to ${NEW_COLOR} on port ${NEW_PORT}"
        docker rm -f ${{ env.CONTAINER_PREFIX }}-${NEW_COLOR} || true

        docker pull ${{ env.IMAGE_NAME }}:${IMAGE_TAG}

        docker run -d \
          --network cleanup-net \
          --name ${{ env.CONTAINER_PREFIX }}-${NEW_COLOR} \
          -p ${NEW_PORT}:8080 \
          --env-file "${ENV_FILE}" \
          -e JWT_SECRET="${JWT_SECRET}" \
          -e JWT_EXPIRES="${JWT_EXPIRES}" \
          -e NODE_ENV="${NODE_ENV}" \
          -e GOOGLE_CLIENT_ID="${GOOGLE_CLIENT_ID}" \
          -e GOOGLE_CLIENT_SECRET="${GOOGLE_CLIENT_SECRET}" \
          -e GOOGLE_REDIRECT_URI="${GOOGLE_REDIRECT_URI}" \
          -e NAVER_CLIENT_ID="${NAVER_CLIENT_ID}" \
          -e NAVER_CLIENT_SECRET="${NAVER_CLIENT_SECRET}" \
          -e NAVER_REDIRECT_URI="${NAVER_REDIRECT_URI}" \
          -e KAKAO_CLIENT_ID="${KAKAO_CLIENT_ID}" \
          -e KAKAO_CLIENT_SECRET="${KAKAO_CLIENT_SECRET}" \
          -e KAKAO_REDIRECT_URI="${KAKAO_REDIRECT_URI}" \
          -e FRONTEND_URL="${FRONTEND_URL}" \
          -e SPRING_PROFILES_ACTIVE="${SPRING_PROFILES_ACTIVE}" \
          -e SPRING_DATASOURCE_URL="${SPRING_DATASOURCE_URL}" \
          -e SPRING_DATASOURCE_USERNAME="${SPRING_DATASOURCE_USERNAME}" \
          -e SPRING_DATASOURCE_PASSWORD="${SPRING_DATASOURCE_PASSWORD}" \
          -e DB_HOST="${DB_HOST}" \
          -e DB_PORT="${DB_PORT}" \
          -e DB_USER="${DB_USER}" \
          -e DB_PASSWORD="${DB_PASSWORD}" \
          -e DB_DATABASE="${DB_DATABASE}" \
          -e REDIS_HOST="${REDIS_HOST}" \
          -e REDIS_PORT="${REDIS_PORT}" \
          -e REDIS_PASSWORD="${REDIS_PASSWORD}" \
          -e JAVA_TOOL_OPTIONS="${JAVA_TOOL_OPTIONS}" \
          ${{ env.IMAGE_NAME }}:${IMAGE_TAG}

        echo "â³ Waiting ${INITIAL_SLEEP}s for the container to warm up..."
        sleep ${INITIAL_SLEEP}

        SUCCESS=0
        for i in $(seq 1 ${RETRIES}); do
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:${NEW_PORT}${HEALTH_PATH}")
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "âœ… Health check passed on attempt $i."
            SUCCESS=1
            break
          fi
          echo "Health check attempt $i failed (HTTP code: $HTTP_CODE). Retrying in ${RETRY_INTERVAL}s..."
          sleep ${RETRY_INTERVAL}
        done

        if [ "$SUCCESS" -ne 1 ]; then
          echo "âŒ Health check failed. Rolling back..."
          docker logs --tail 200 ${{ env.CONTAINER_PREFIX }}-${NEW_COLOR} || true
          docker rm -f ${{ env.CONTAINER_PREFIX }}-${NEW_COLOR} || true
          exit 1
        fi

        echo "âœ… New container is healthy, switching Nginx..."
        sudo sed -i "s|127.0.0.1:[0-9]\+|127.0.0.1:${NEW_PORT}|" /etc/nginx/conf.d/spring-upstream.conf
        sudo nginx -t && sudo systemctl reload nginx

        echo "ðŸ§¹ Cleaning up old container: ${CONTAINER_PREFIX}-${OLD_COLOR}"
        docker rm -f ${{ env.CONTAINER_PREFIX }}-${OLD_COLOR} || true

        echo "ðŸŽ‰ Deployment complete and Nginx switched to ${NEW_COLOR} (port ${NEW_PORT})"

    - name: Post-build cleanup (safe)
      run: |
        echo "ðŸ§¹ Post-build cleanup..."
        docker buildx prune --keep-storage 2GB -f || true
        docker system prune -a -f || true
        if command -v dnf >/dev/null 2>&1; then
          sudo dnf clean all || true
          sudo rm -rf /var/cache/dnf || true
        elif command -v apt-get >/dev/null 2>&1; then
          sudo apt-get clean || true
          sudo rm -rf /var/cache/apt/archives/* || true
        fi
        sudo journalctl --vacuum-size=200M || true
