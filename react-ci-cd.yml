# ì›Œí¬í”Œë¡œìš°ì˜ ì´ë¦„ì„ ì§€ì •í•©ë‹ˆë‹¤.
name: React Frontend CI/CD (Blue/Green)

# ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì¡°ê±´ì„ ì •ì˜í•©ë‹ˆë‹¤.
on:
  # 1. main ë¸Œëžœì¹˜ì— ì½”ë“œê°€ í‘¸ì‹œë  ë•Œ ìžë™ìœ¼ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤.
  push:
    branches:
      - main
  # 2. GitHub Actions íƒ­ì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰í•  ìˆ˜ ìžˆë„ë¡ í•©ë‹ˆë‹¤.
  workflow_dispatch:

# ì‹¤í–‰ë  ìž‘ì—…ì„ ì •ì˜í•©ë‹ˆë‹¤.
jobs:
  build-and-deploy:
    # ì´ ìž‘ì—…ì´ EC2ì— ì„¤ì¹˜í•œ self-hosted ëŸ¬ë„ˆì—ì„œ ì‹¤í–‰ë˜ë„ë¡ ì§€ì •í•©ë‹ˆë‹¤.
    runs-on: self-hosted

    steps:
    # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ: GitHub ì €ìž¥ì†Œì˜ ì½”ë“œë¥¼ ëŸ¬ë„ˆ(EC2)ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.
    - name: Checkout code
      uses: actions/checkout@v3

    # 2. GHCR ë¡œê·¸ì¸: Docker ì´ë¯¸ì§€ë¥¼ í‘¸ì‹œí•˜ê¸° ìœ„í•´ GitHub Container Registryì— ë¡œê·¸ì¸í•©ë‹ˆë‹¤.
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GHCR_TOKEN }}

    # 3. Docker Buildx ì„¤ì •: ê³ ê¸‰ ê¸°ëŠ¥ì„ ì§€ì›í•˜ëŠ” Docker ë¹Œë“œ ì—”ì§„ì„ ì„¤ì •í•©ë‹ˆë‹¤.
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # 4. Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ: React ì•±ì„ Docker ì´ë¯¸ì§€ë¡œ ë§Œë“¤ê³  GHCRì— ì—…ë¡œë“œí•©ë‹ˆë‹¤.
    - name: Build and push React Docker image
      uses: docker/build-push-action@v4
      with:
        context: ./frontend
        push: true
        tags: ghcr.io/seoulbhin/cleanup-street-react:latest
        # GitHub ìºì‹œ ì„œë¹„ìŠ¤ê°€ ë¶ˆì•ˆì •í•  ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ìºì‹œ ê¸°ëŠ¥ì€ ë¹„í™œì„±í™” ìƒíƒœë¡œ ë‘¡ë‹ˆë‹¤.
        # cache-from: type=gha
        # cache-to: type=gha,mode=max

    # 5. ë¸”ë£¨/ê·¸ë¦° ì „ëžµìœ¼ë¡œ ë°°í¬: EC2 ì„œë²„ì—ì„œ ë¬´ì¤‘ë‹¨ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
    - name: Deploy with Blue/Green Strategy
      run: |
        echo "Starting React Frontend Blue/Green Deployment..."

        EXISTING_BLUE=$(docker ps -q -f name=cleanup-street-react-blue)
        
        if [ -z "$EXISTING_BLUE" ]; then
          NEW_COLOR="blue"
          OLD_COLOR="green"
          NEW_PORT=8080
        else
          NEW_COLOR="green"
          OLD_COLOR="blue"
          NEW_PORT=8081
        fi

        echo "Deploying new React app to ${NEW_COLOR} on EC2 host port ${NEW_PORT}"
        
        docker pull ghcr.io/seoulbhin/cleanup-street-react:latest
        docker run -d \
                   --name cleanup-street-react-${NEW_COLOR} \
                   -p ${NEW_PORT}:80 \
                   ghcr.io/seoulbhin/cleanup-street-react:latest

        echo "Waiting for React app on port ${NEW_PORT} to be healthy..."
        sleep 10
        for i in {1..20}; do
          if curl -s http://localhost:${NEW_PORT} > /dev/null; then
            echo "Health check passed!"
            echo "Switching Nginx traffic to port ${NEW_PORT}"
            echo "upstream react_servers { server 127.0.0.1:${NEW_PORT}; }" | sudo tee /etc/nginx/conf.d/react-upstream.conf
            sudo systemctl reload nginx

            OLD_CONTAINER=$(docker ps -q -f name=cleanup-street-react-${OLD_COLOR})
            if [ -n "$OLD_CONTAINER" ]; then
              echo "Stopping and removing old container: cleanup-street-react-${OLD_COLOR}"
              docker stop cleanup-street-react-${OLD_COLOR}
              docker rm cleanup-street-react-${OLD_COLOR}
            fi
            echo "React Frontend Deployment successful!"
            exit 0
          fi
          echo "Health check attempt $i failed. Retrying..."
          sleep 5
        done
        
        # í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨ ì‹œ ì›ëž˜ì˜ ë¡¤ë°± ë¡œì§ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
        echo "Health check failed. Rolling back."
        docker stop cleanup-street-react-${NEW_COLOR}
        docker rm cleanup-street-react-${NEW_COLOR}
        exit 1 # ë°°í¬ ì‹¤íŒ¨ë¡œ ì¢…ë£Œ

    - name: Post-build cleanup (safe)
      run: |
        echo "ðŸ§¹ Post-build cleanup..."
        docker buildx prune --keep-storage 2GB -f || true
        docker system prune -a -f || true
        if command -v dnf >/dev/null 2>&1; then
          sudo dnf clean all || true
          sudo rm -rf /var/cache/dnf || true
        elif command -v apt-get >/dev/null 2>&1; then
          sudo apt-get clean || true
          sudo rm -rf /var/cache/apt/archives/* || true
        fi
        sudo journalctl --vacuum-size=200M || true

