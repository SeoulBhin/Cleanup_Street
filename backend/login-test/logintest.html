<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>OAuth ë¡œê·¸ì¸ & ì¢‹ì•„ìš” í…ŒìŠ¤íŠ¸</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 40px auto;
      padding: 20px;
      background: #f7f7f7;
    }

    h1 { text-align: center; }

    .btn {
      display: block;
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      text-align: center;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      border: none;
    }

    .google { background: #ffffff; border: 1px solid #ccc; }
    .kakao  { background: #fee500; }
    .naver  { background: #03c75a; color: white; }

    .logout {
      margin-top: 20px;
      background: #e53e3e;
      color: white;
    }

    .card {
      background: white;
      padding: 16px;
      border-radius: 8px;
      margin-top: 20px;
      word-break: break-all;
    }

    pre {
      white-space: pre-wrap;
      word-break: break-word;
    }
  </style>
</head>

<body>
  <h1>OAuth ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸</h1>

  <!-- ë¡œê·¸ì¸ ë²„íŠ¼ë“¤ -->
  <button class="btn google" onclick="login('google')">Google ë¡œê·¸ì¸</button>
  <button class="btn kakao" onclick="login('kakao')">Kakao ë¡œê·¸ì¸</button>
  <button class="btn naver" onclick="login('naver')">Naver ë¡œê·¸ì¸</button>

  <div id="result"></div>

  <!-- ì¢‹ì•„ìš” í…ŒìŠ¤íŠ¸ ë²„íŠ¼ -->
  <button class="btn" style="background:#4a90e2; color:#fff;" onclick="likeTest(1)">
    ğŸ‘ ê²Œì‹œê¸€ 1ë²ˆ ì¢‹ì•„ìš” í…ŒìŠ¤íŠ¸
  </button>

<script>
  const API_BASE = "http://localhost:8080/api/oauth";

  /* ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­ */
  function login(provider) {
    window.location.href = `${API_BASE}/${provider}/login`;
  }

  /* JWT ë””ì½”ë”© */
  function parseJwt(token) {
    try {
      const base64 = token.split('.')[1]
        .replace(/-/g, '+')
        .replace(/_/g, '/');
      return JSON.parse(atob(base64));
    } catch {
      return null;
    }
  }

  /* OAuth ì½œë°± ì²˜ë¦¬ */
  function handleCallback() {
    if (!location.hash) return;

    const hash = location.hash.substring(1);
    const params = new URLSearchParams(hash);

    const provider = params.get("provider");
    const token = params.get("token");

    if (!token) return;

    const payload = parseJwt(token);

    // í† í° ì €ì¥
    localStorage.setItem("oauth_token", token);
    localStorage.setItem("oauth_provider", provider);

    renderUserInfo(provider, token, payload);

    // URL ê¹”ë”í•˜ê²Œ ì •ë¦¬ (# ì œê±°)
    history.replaceState(null, "", location.pathname);
  }

  /* ë¡œê·¸ì¸ ì •ë³´ ì¶œë ¥ */
  function renderUserInfo(provider, token, payload) {
    document.getElementById("result").innerHTML = `
      <div class="card">
        <h3>ë¡œê·¸ì¸ Provider</h3>
        <p><b>${provider}</b></p>

        <h3>JWT Token</h3>
        <pre>${token}</pre>

        <h3>Payload</h3>
        <pre>${JSON.stringify(payload, null, 2)}</pre>

        <button class="btn logout" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    `;
  }

  /* ë¡œê·¸ì•„ì›ƒ */
  function logout() {
    localStorage.removeItem("oauth_token");
    localStorage.removeItem("oauth_provider");
    location.reload();
  }

  /* ìƒˆë¡œê³ ì¹¨ ì‹œ í† í° ë³µì› */
  function restoreLogin() {
    const token = localStorage.getItem("oauth_token");
    const provider = localStorage.getItem("oauth_provider");

    if (!token) return;

    const payload = parseJwt(token);
    renderUserInfo(provider, token, payload);
  }

  /* ì¢‹ì•„ìš” í…ŒìŠ¤íŠ¸ API */
  async function likeTest(postId) {
    const token = localStorage.getItem("oauth_token");

    if (!token) {
      alert("ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”!");
      return;
    }

    const res = await fetch(`http://localhost:8080/api/posts/${postId}/reactions/like`, {
      method: 'POST',
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json"
      }
    });

    const data = await res.json();
    console.log("ì¢‹ì•„ìš” API ì‘ë‹µ:", data);

    alert(data.liked ? "ğŸ‘ ì¢‹ì•„ìš” ì„±ê³µ" : "ğŸ’” ì¢‹ì•„ìš” ì·¨ì†Œ");
  }

  /* í˜ì´ì§€ ë¡œë“œ ì‹œ */
  window.onload = () => {
    handleCallback();
    restoreLogin();
  };
</script>
</body>
</html>
