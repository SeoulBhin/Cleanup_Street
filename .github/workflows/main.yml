name: Full CI/CD

# íŠ¸ë¦¬ê±°ë¥¼ ìˆ˜í–‰í•  ë¸Œëžœì¹˜ë¥¼ ì§€ì •
on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: self-hosted
    env:
      # í™˜ê²½ì„¤ì •
      BE_IMAGE: ghcr.io/seoulbhin/cleanup-street-spring
      FE_IMAGE: ghcr.io/seoulbhin/cleanup-street-react
      BE_PREFIX: cleanup-street-spring
      FE_PREFIX: cleanup-street-react
      BE_BLUE_PORT: 9090
      BE_GREEN_PORT: 9091
      FE_BLUE_PORT: 8080
      FE_GREEN_PORT: 8081
      HEALTH_PATH: "/api/hello"
      INITIAL_SLEEP: 25
      RETRIES: 12
      RETRY_INTERVAL: 5

    steps:
      # github repositoryì—ì„œ checkout
      - name: Checkout
        uses: actions/checkout@v3
      # GitHub ì»¨í…Œì´ë„ˆ ë ˆì§€ìŠ¤íŠ¸ë¦¬ì— ë¡œê·¸ì¸ í›„ ë¹Œë“œ & í‘¸ì‹œ
      - name: Login to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}
          
      - name: Build & Push Backend
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          push: true
          tags: |
            ${{ env.BE_IMAGE }}:${{ github.sha }}
            ${{ env.BE_IMAGE }}:latest

      - name: Build & Push Frontend
        uses: docker/build-push-action@v4
        with:
          context: ./frontend
          push: true
          build-args: |
            REACT_APP_API_BASE_URL=http://52.63.57.185
          tags: |
            ${{ env.FE_IMAGE }}:${{ github.sha }}
            ${{ env.FE_IMAGE }}:latest

      - name: Deploy with Blue/Green Strategy
        env:
          IMAGE_TAG: ${{ github.sha }}
          # DB Configuration
          DB_HOST: 52.63.57.185
          DB_PORT: 5433
          DB_USER: user
          DB_PASSWORD: 1234
          DB_DATABASE: cleanup
          REDIS_HOST: cleanup-redis
          REDIS_PORT: 6379
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
          BYPASS_AUTH: "true"
        run: |
          echo "ðŸš€ Starting Blue/Green Deployment for tag: ${IMAGE_TAG}"

          # Ensure shared network for app + redis
          docker network create cleanup-net || true

          # Defaults (secrets may be empty in self-hosted runner)
          DB_HOST=${DB_HOST:-52.63.57.185}
          DB_PORT=${DB_PORT:-5433}
          DB_USER=${DB_USER:-user}
          DB_PASSWORD=${DB_PASSWORD:-1234}
          DB_DATABASE=${DB_DATABASE:-cleanup}
          REDIS_HOST=${REDIS_HOST:-cleanup-redis}
          REDIS_PORT=${REDIS_PORT:-6379}
          REDIS_PASSWORD=${REDIS_PASSWORD:-0000}

          # Decide next colors
          BE_EXISTING=$(docker ps -q -f name=${BE_PREFIX}-blue || true)
          if [ -z "$BE_EXISTING" ]; then
            BE_NEW_COLOR=blue; BE_NEW_PORT=${BE_BLUE_PORT}; BE_OLD_COLOR=green
          else
            BE_NEW_COLOR=green; BE_NEW_PORT=${BE_GREEN_PORT}; BE_OLD_COLOR=blue
          fi

          FE_EXISTING=$(docker ps -q -f name=${FE_PREFIX}-blue || true)
          if [ -z "$FE_EXISTING" ]; then
            FE_NEW_COLOR=blue; FE_NEW_PORT=${FE_BLUE_PORT}; FE_OLD_COLOR=green
          else
            FE_NEW_COLOR=green; FE_NEW_PORT=${FE_GREEN_PORT}; FE_OLD_COLOR=blue
          fi

          echo "BE -> ${BE_NEW_COLOR}:${BE_NEW_PORT}, FE -> ${FE_NEW_COLOR}:${FE_NEW_PORT}"

          # Remove stale containers
          docker rm -f ${BE_PREFIX}-${BE_NEW_COLOR} || true
          docker rm -f ${FE_PREFIX}-${FE_NEW_COLOR} || true

          # Run new containers
          # Backend: Pass DB env vars
          docker run -d --name ${BE_PREFIX}-${BE_NEW_COLOR} -p ${BE_NEW_PORT}:8080 \
            --network cleanup-net \
            -e PORT=8080 \
            -e DB_HOST="${DB_HOST}" \
            -e DB_PORT="${DB_PORT}" \
            -e DB_USER="${DB_USER}" \
            -e DB_PASSWORD="${DB_PASSWORD}" \
            -e DB_DATABASE="${DB_DATABASE}" \
            -e REDIS_HOST="${REDIS_HOST}" \
            -e REDIS_PORT="${REDIS_PORT}" \
            -e REDIS_PASSWORD="${REDIS_PASSWORD}" \
            -e BYPASS_AUTH="${BYPASS_AUTH}" \
            -e KAKAO_REST_API_KEY_Value="${{ secrets.KAKAO_REST_API_KEY_Value }}" \
            ${BE_IMAGE}:${IMAGE_TAG}

          # Frontend
          docker run -d --name ${FE_PREFIX}-${FE_NEW_COLOR} -p ${FE_NEW_PORT}:80 \
            --network cleanup-net \
            ${FE_IMAGE}:${IMAGE_TAG}

          echo "â³ Waiting for warm-up..."
          sleep ${INITIAL_SLEEP}

          code=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:${BE_NEW_PORT}${HEALTH_PATH}" || echo "000")
          if [ "$code" != "200" ]; then
            echo "âŒ Backend health check failed"
            docker logs ${BE_PREFIX}-${BE_NEW_COLOR} || true
            exit 1
          fi

          echo "âœ… Backend healthy, updating NGINX config"
          sudo tee /etc/nginx/conf.d/app.conf > /dev/null <<EOL
            server {
                listen 80;
                server_name _;

                # Proxy API requests to Backend
                location /api/ {
                    proxy_pass http://127.0.0.1:${BE_NEW_PORT}/api/;
                    proxy_set_header Host \$host;
                    proxy_set_header X-Real-IP \$remote_addr;
                    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                }

                # Proxy Socket.IO (websocket) to Backend
                location /socket.io/ {
                    proxy_pass http://127.0.0.1:${BE_NEW_PORT};
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade \$http_upgrade;
                    proxy_set_header Connection "Upgrade";
                    proxy_set_header Host \$host;
                    proxy_set_header X-Real-IP \$remote_addr;
                    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto \$scheme;
                    proxy_read_timeout 600s;
                    proxy_send_timeout 600s;
                }

                # Serve Frontend
                location / {
                    proxy_pass http://127.0.0.1:${FE_NEW_PORT};
                    proxy_set_header Host \$host;
                    proxy_set_header X-Real-IP \$remote_addr;
                    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                }
            }
          EOL
          sudo nginx -t && sudo systemctl reload nginx

          echo "ðŸ§¹ Remove old containers"
          docker rm -f ${BE_PREFIX}-${BE_OLD_COLOR} || true
          docker rm -f ${FE_PREFIX}-${FE_OLD_COLOR} || true

          echo "ðŸŽ‰ Deployment complete"
